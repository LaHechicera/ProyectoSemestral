<!DOCTYPE html>
<html>
<head>
<title>Elige tu Aventura</title>
<link rel="stylesheet" href="escoger.css" />
<link rel="stylesheet" href="custom-titlebar.css" />
<script>
const { ipcRenderer } = require('electron');

// Guarda el tiempo de inicio al cargar esta página
window.onload = () => {
if (!localStorage.getItem('inicioJuego')) {
localStorage.setItem('inicioJuego', Date.now());
}
};

function selectStory(type) {
// Mostrar opciones según tipo
if (type === 'humano') {
document.getElementById('gender-section-humano').style.display = 'block';
document.getElementById('gender-section-elfo').style.display = 'none';
} else if (type === 'elfo') {
document.getElementById('gender-section-humano').style.display = 'none';
document.getElementById('gender-section-elfo').style.display = 'block';
}

// Obtener datos del usuario
const usuarioId = localStorage.getItem('usuarioId') || 'desconocido';
const decisiones = 'Seleccionó raza: ' + type;
const tiempoJuego = calcularTiempo();
const opciones = type;

// Enviar los datos al backend
ipcRenderer.send('guardar-decision', {
usuarioId,
decisiones,
tiempoJuego,
opciones
});
}

function calcularTiempo() {
const inicio = localStorage.getItem('inicioJuego');
const ahora = Date.now();
const minutos = Math.floor((ahora - parseInt(inicio)) / 60000);
return minutos + ' minutos';
}
document.addEventListener('DOMContentLoaded', () => {
            const restartBtn = document.getElementById('restart-btn');
            const quitBtn = document.getElementById('quit-btn');
            const titlebar = document.querySelector('.custom-titlebar');

            if (restartBtn) {
                restartBtn.addEventListener('click', () => {
                    window.electronAPI.restartApp();
                });
            }
            if (quitBtn) { // Listener para el botón de salida
                quitBtn.addEventListener('click', () => {
                    window.electronAPI.quitApp(); // ¡Esta función debería funcionar ahora!
                });
            }
            if (titlebar) { // El doble clic seguirá maximizando/restaurando la ventana
                titlebar.addEventListener('dblclick', () => {
                    window.electronAPI.maximizeRestoreWindow();
                });
            }
        });

</script>
</head>
<body>
    <div class="custom-titlebar">
    <!--<div class="custom-titlebar-title">Elige tu Aventura</div> Puedes personalizar este título por página -->
    <div class="app-controls"> 
        <button id="restart-btn" title="Reiniciar Aplicación">↻</button>
        <button id="quit-btn" class="close-button" title="Salir de la Aplicación">✖</button>
    </div>
</div>
<div class="main-container">
    <div class="left-panel">
        <h1>Elige tu Historia</h1>
    </div>

    <div class="right-panel">
        <div class="button-group">
            <button onclick="selectStory('humano')">Humano</button>
            <button onclick="selectStory('elfo')">Elfo</button>
        </div>

        <div id="gender-section-humano" class="gender-section" style="display: none;">
            <h2>Género (Humano)</h2>
            <div class="button-group">
                <button onclick="savePreferencesAndRedirect('humano', 'Hombre', './HistoriaHumano/1_Reino/Historia1Hombre.html')">Hombre</button>
                <button onclick="savePreferencesAndRedirect('humano', 'Mujer', './HistoriaHumano/1_Reino/Historia1Mujer.html')">Mujer</button>
            </div>
        </div>

        <div id="gender-section-elfo" class="gender-section" style="display: none;">
            <h2>Género (Elfo)</h2>
            <div class="button-group">
                <button onclick="savePreferencesAndRedirect('elfo', 'Hombre', './HistoriaElfo/wakeupH.html')">Hombre</button>
                <button onclick="savePreferencesAndRedirect('elfo', 'Mujer', './HistoriaElfo/wakeupM.html')">Mujer</button>
            </div>
        </div>
    </div>
</div>

<script>

    function selectStory(type) {
        // Mostrar opciones según tipo
        if (type === 'humano') {
            document.getElementById('gender-section-humano').style.display = 'block';
            document.getElementById('gender-section-elfo').style.display = 'none';
        } else if (type === 'elfo') {
            document.getElementById('gender-section-humano').style.display = 'none';
            document.getElementById('gender-section-elfo').style.display = 'block';
        }
        // Almacena la raza seleccionada, el género se manejará al hacer clic en el botón de género
        localStorage.setItem('selectedStoryType', type);
    }

    async function savePreferencesAndRedirect(selectStoryType, genero, targetUrl) {
        const userId = localStorage.getItem('usuarioId'); // Obtener el ID del usuario del localStorage

        if (!userId) {
            alert('Error: ID de usuario no encontrado. Por favor, inicia sesión de nuevo.');
            window.location.href = '../../usuario.html'; // Redirige a la página de login
            return;
        }

        if (window.api && typeof window.api.updateUserPreferences === 'function') {
            try {
                const result = await window.api.updateUserPreferences(userId, selectStoryType, genero);

                if (result.success) {
                    window.location.href = targetUrl;
                } else {
                    alert('Error al guardar tus preferencias: ' + result.message);
                    window.location.href = targetUrl; // Redirige de todas formas
                }
            } catch (error) {
                alert('Ocurrió un error al comunicarse con la aplicación: ' + error.message);
                window.location.href = targetUrl; // Redirige de todas formas
            }
        } else {
            alert('Error: Funcionalidad de guardar preferencias no disponible. Asegúrate de que Electron API esté cargada.');
            window.location.href = targetUrl; // Redirige directamente
        }
    }
</script>
</body>
</html>